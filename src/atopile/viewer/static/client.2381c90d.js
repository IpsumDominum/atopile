const{shapes:t,util:e,dia:n,anchors:o}=joint;let i={common:{backgroundColor:"rgba(224, 233, 227, 0.3)",gridSize:5,parentPadding:50,fontFamily:"monospace",fontHeightToPxRatio:1.6,fontLengthToPxRatio:.7},component:{strokeWidth:2,fontSize:8,fontWeight:"bold",defaultWidth:60,portPitch:20,defaultHeight:50,labelHorizontalMargin:30,labelVerticalMargin:4,titleMargin:10,pin:{fontSize:8,fontWeight:"normal"}},block:{strokeWidth:2,boxRadius:5,strokeDasharray:"4,4",label:{fontSize:10,fontWeight:"bold"}},link:{strokeWidth:1,color:"blue"},stubs:{fontSize:8}};class l extends n.Element{defaults(){return{...super.defaults,instance_name:null,config_origin_filename:null,config_origin_module:[]}}addPortWithPins(t,e,n){let o=function(t){switch(t){case"top":return[0,5];case"bottom":return[0,-5];case"left":return[5,0];case"right":return[-5,0];default:return[0,0]}}(e),l=function(t){switch(t){case"top":case"right":return"end";case"bottom":case"left":return"start";default:return"middle"}}(e),a=function(t){switch(t){case"top":case"bottom":return -90;default:return 0}}(e),r=function(t){switch(t){case"top":return{name:"line",args:{start:{x:i.component.labelHorizontalMargin,y:0},end:{x:"calc(w - "+i.component.labelHorizontalMargin+")",y:0}}};case"bottom":return{name:"line",args:{start:{x:i.component.labelHorizontalMargin,y:"calc(h)"},end:{x:"calc(w - "+i.component.labelHorizontalMargin+")",y:"calc(h)"}}};case"left":return{name:"line",args:{start:{x:0,y:i.component.labelVerticalMargin},end:{x:0,y:"calc(h - "+i.component.labelVerticalMargin+")"}}};case"right":return{name:"line",args:{start:{x:"calc(w)",y:i.component.labelVerticalMargin},end:{x:"calc(w)",y:"calc(h - "+i.component.labelVerticalMargin+")"}}};default:return 0}}(e),c={};for(let e of(c[t]={position:r,attrs:{portBody:{magnet:!0,r:2,fill:"#FFFFFF",stroke:"#023047"}},label:{position:{args:{x:o[0],y:o[1],angle:a}},markup:[{tagName:"text",selector:"label",className:"label-text"}]},markup:[{tagName:"circle",selector:"portBody"}]},this.prop({ports:{groups:c}}),n)){var s;this.addPort((s=e.path,{id:s,group:t,attrs:{label:{text:e.name,fontFamily:i.common.fontFamily,fontSize:i.component.pin.fontSize,fontWeight:i.component.pin.fontWeight,textAnchor:l}}}))}}resizeBasedOnContent(){if(this.getPorts()){let t={top:this.getGroupPorts("top"),bottom:this.getGroupPorts("bottom"),left:this.getGroupPorts("left"),right:this.getGroupPorts("right")},e={top:"",bottom:"",left:"",right:""},n={height:0,width:0},o={height:0,width:0};for(let n in t)if(t[n].length)for(let o of t[n])o.attrs.label.text.length>e[n].length&&(e[n]=o.attrs.label.text);n.height=2*Math.max(s(e.top,i.component.fontSize,"length"),s(e.bottom,i.component.fontSize,"length")),n.height+=s(this.attributes.attrs.label.text,i.component.fontSize,"height"),n.height+=2*i.component.labelVerticalMargin,n.width=2*Math.max(s(e.right,i.component.fontSize,"length"),s(e.left,i.component.fontSize,"length")),n.width+=s(this.attributes.attrs.label.text,i.component.fontSize,"length"),o.height=(Math.max(t.right.length,t.left.length)+1)*i.component.portPitch,o.width=(Math.max(t.top.length,t.bottom.length)-1)*i.component.portPitch,o.width+=2*i.component.labelHorizontalMargin,this.resize(Math.max(n.width,o.width),Math.max(n.height,o.height))}}fitAncestorElements(){var t=i.common.parentPadding;this.fitParent({deep:!0,padding:{top:t,left:t,right:t,bottom:t}})}applyParentAttrs(t){"position"in t&&this.position(t.position.x,t.position.y,{deep:!0})}}class a extends l{defaults(){return{...super.defaults(),type:"AtoComponent",attrs:{body:{fill:"white",z:10,stroke:"black",strokeWidth:i.component.strokeWidth,width:"calc(w)",height:"calc(h)",rx:5,ry:5},label:{text:"Component",fill:"black",fontSize:i.component.fontSize,fontWeight:i.component.fontWeight,textVerticalAnchor:"middle",textAnchor:"middle",fontFamily:i.common.fontFamily,x:"calc(w/2)",y:"calc(h/2)"}}}}preinitialize(){this.markup=e.svg`
            <rect @selector="body" />
            <text @selector="label" />
        `}}class r extends l{defaults(){return{...super.defaults(),type:"AtoComponent",collapsed:!1,attrs:{body:{fill:"transparent",stroke:"#333",strokeWidth:i.block.strokeWidth,strokeDasharray:i.block.strokeDasharray,width:"calc(w)",height:"calc(h)",rx:i.block.boxRadius,ry:i.block.boxRadius},label:{text:"Block",fill:"black",textVerticalAnchor:"top",fontSize:i.block.label.fontSize,fontWeight:i.block.label.fontWeight,textAnchor:"start",fontFamily:i.common.fontFamily,x:8,y:8}}}}preinitialize(){this.markup=e.svg`
            <rect @selector="body" />
            <text @selector="label" />
        `}updateChildrenVisibility(){let t=this.isCollapsed();this.getEmbeddedCells().forEach(e=>e.set("hidden",t))}}const c={...t,AtoElement:l,AtoComponent:a,AtoBlock:r};function s(t,e,n){var o=(t+"").split("\n"),l=0;for(let t of o){var a=t.length;a>l&&(l=a)}return"length"==n?l*e*i.common.fontLengthToPxRatio:"height"==n?o.length*e*i.common.fontHeightToPxRatio:0}function h(e,n,o){let l=new t.standard.Link({source:{id:e,port:n,anchor:{name:"center"}},target:{id:e,port:n,anchor:{name:"customAnchor"},connectionPoint:{name:"anchor"}}});l.attr({line:{stroke:i.link.color,"stroke-width":i.link.strokeWidth,targetMarker:{type:"none"}},z:0}),l.appendLabel({attrs:{text:{text:o,fontFamily:i.common.fontFamily,fontSize:i.stubs.fontSize,textAnchor:"middle"}},position:{distance:.9,offset:-5,angle:0,args:{keepGradient:!0,ensureLegibility:!0}}}),_.addCell(l)}function f(t,e,n){let o,i,l=u(e,t);switch(t.split(".").length){case 1:o=e;break;case 2:o=u(e,(i=b(t)).pop);break;default:for(let a of(console.log("default"),o=u(e,(i=b(t)).pop),n))a.id==o&&a.addPortWithPins("top","top",[{path:l,name:i.remaining}])}return console.log({cell_id:o,port_id:l}),{cell_id:o,port_id:l}}function g(t){return null!=t.instance_of?`${t.name} 
(${function(t){let e=t.split(":"),n=e[0],o=e[1].split("."),i=o.slice(0,o.length-1),l=n+":"+i.join("."),a=o[o.length-1];return{file:n,path:l,name:a}}(t.instance_of).name})`:t.name}function d(t,e,n){let o,i={};for(let t of(e.config||{}).ports||[])i[t.name||"top"]={location:t.location||"top",pins:[]};for(let t of e.pins){for(let l of(t.path=u(n,t.name),o=!1,(e.config||{}).pins||[]))t.name==l.name&&(i[l.port].pins.push(t),o=!0);o||(i.top||(i.top={location:"top",pins:[]}),i.top.pins.push(t))}for(let e in i)i[e].pins.length>0&&t.addPortWithPins(e,i[e].location,i[e].pins)}function p(t,e){e.embed(t)}function m(t){if(!t)return null;{let[e,n]=t.split(":");return{file:e,module:n}}}function u(t,e){return null==t?e+":":":"==t.slice(-1)?t+e:t+"."+e}function b(t){let e=t.split("."),n=e.slice(1,e.length),o=n.join("."),i=e[0];return{pop:i,remaining:o}}function k(t,e){if(null!==e&&Object.keys(e).length>0)for(let n in e)n==t.name&&t.jointObject.applyParentAttrs(e[n])}async function w(e,n,o=0,l=null,c=null,m=null){let b;let y=o+1;if(!(o<=n))return!1;for(let P of e){var z=null;if("component"==P.type)b=u(l,P.name),z=function(t,e,n){let o=g(t),l=s(o,i.component.pin.fontSize,"length")+2*i.component.titleMargin,r=s(o,i.component.pin.fontSize,"height")+2*i.component.titleMargin;var c=new a({id:n,instance_name:t.name,size:{width:l,height:r},attrs:{label:{text:o}},config_origin_filename:t.config_origin_filename,config_origin_module:t.config_origin_module});return d(c,t,n),c.resizeBasedOnContent(),c.addTo(_),e&&p(c,e),c}(P,c,b),P.jointObject=z,c&&p(z,c),k(P,m);else if("module"==P.type){if(b=u(l,P.name),z=function(t,e,n){let o=g(t),i=new r({id:n,instance_name:t.name,size:{width:200,height:100},attrs:{label:{text:o}},config_origin_filename:t.config_origin_filename,config_origin_module:t.config_origin_module});return d(i,t,n),i.addTo(_),e&&p(i,e),i}(P,c,b),P.jointObject=z,c&&p(z,c),await w(P.blocks,n,y,b,z,P.config.child_attrs)&&(function(e,n,o){for(let l of e.links){let a=f(l.source,n,o),r=f(l.target,n,o),c=!1;for(let t of(e.config||{}).signals||[])t.name==l.name&&t.is_stub&&(c=!0,n.length!=a.cell_id.length&&h(a.cell_id,a.port_id,l.name),n.length!=r.cell_id.length&&h(r.cell_id,r.port_id,l.name));c||function(e,n,o,l){var a=new t.standard.Link({source:{id:e,port:n},target:{id:o,port:l}});a.attr({line:{stroke:i.link.color,"stroke-width":i.link.strokeWidth,targetMarker:{type:"none"}},z:0}),a.router("manhattan",{perpendicular:!0,step:i.common.gridSize}),a.addTo(_)}(a.cell_id,a.port_id,r.cell_id,r.port_id)}}(P,b,z.getEmbeddedCells()),k(P,m)),0==o){let t=x.getComputedSize(),e=z.size(),n=t.width/2-e.width/2,o=t.height/2-e.height/2;z.position(n,o)}}else"file"==P.type?(b=u(l,P.name),await w(P.blocks,n,y,b)):console.log("Unknown element type: "+P.type)}return!0}async function y(t,e=null){let n,o=[];for(let e of t){if("component"==e.type){if(null!==e.instance_of){n=m(e.instance_of),e.config_origin_filename=P(n.file),e.config_origin_module=n.module;let t=await S(n.file);e.config=t[n.module]||{}}}else if("module"==e.type){let t=null;e.config={},null!==e.instance_of&&(n=m(e.instance_of),e.config_origin_filename=P(n.file),e.config_origin_module=n.module,t=await S(n.file)),t&&0!==Object.keys(t).length&&t.hasOwnProperty(n.module)&&(e.config=t[n.module]),e.blocks=await y(e.blocks)}else"file"==e.type?e.blocks=await y(e.blocks,e.name):console.log("unknown block type");o.push(e)}return o}const _=new n.Graph({},{cellNamespace:c}),x=new joint.dia.Paper({el:document.getElementById("atopilePaper"),model:_,width:"100%",height:"100%",gridSize:i.common.gridSize,drawGrid:!0,background:{color:i.common.backgroundColor},interactive:!0,snapLinks:!0,linkPinning:!1,magnetThreshold:"onleave",cellViewNamespace:c,anchorNamespace:{...joint.anchors,customAnchor:function(t,e,n,o,i,l){let a=t.model.getBBox(),r=t.getNodeBBox(e).center(),c=a.sideNearestToPoint(r),s=0,h=0,f="length"in o?o.length:30;switch(c){case"left":s=-f;break;case"right":s=f;break;case"top":h=-f;break;case"bottom":h=f}return joint.anchors.center.call(this,t,e,n,{...o,dx:s,dy:h},i,l)}}});function z(){x.setDimensions(window.innerWidth,window.innerHeight)}function P(t){return t.replace(".ato","")+".vis.json"}async function S(t){let e,n="/api/config/"+P(t);try{e=await fetch(n)}catch(t){console.log("Could not fetch config ",t)}return e.ok?await e.json():(console.log(`HTTP Response Code: ${e?.status}`),null)}async function M(){let t=new URLSearchParams(window.location.search),e=await fetch("/api/circuit/"+t.get("circuit")),n=await e.json();console.log("data received from backend"),console.log(n);let o=await y([n]);console.log(o),w(o,1)}window.onload=z,window.onresize=z,x.on("link:mouseenter",function(t){t.showTools(),t.highlight()}),x.on("link:mouseleave",function(t){t.hideTools(),t.unhighlight()}),_.on("change:position",function(t){t.fitAncestorElements()});var W=!1;x.on("cell:pointerup",function(t,e,n,o){(t.model instanceof a||t.model instanceof r)&&(W=!0)}),setInterval(function(){W&&(console.log("saving positions"),function(){let t={};for(let e in _.getCells().forEach(function(e){if(e instanceof a||e instanceof r){console.log(e.id);let n=e.getParentCell();if(!n)return;let o=n.attributes.config_origin_filename,i=n.attributes.config_origin_module,l=e.attributes.instance_name;t[o]||(t[o]={}),t[o][i]||(t[o][i]={child_attrs:{}}),t[o][i].child_attrs[l]={position:{x:e.attributes.position.x-n.attributes.position.x,y:e.attributes.position.y-n.attributes.position.y}}}}),t){let n={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t[e])};fetch("/api/config/"+e,n)}W=!1}())},1e3),M();
//# sourceMappingURL=client.2381c90d.js.map
